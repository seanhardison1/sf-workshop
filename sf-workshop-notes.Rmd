---
title: "spatial-intro"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, include = T, warning = F)

#A function to install missing packages

packages <- c("tidyverse", "sf", "stars", "raster", "here","rgdal", "lwgeom")

installLoadPackages <- function(pkg){
    new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
    if (length(new.pkg)) 
        install.packages(new.pkg, dependencies = TRUE,repos='http://cran.us.r-project.org')
    sapply(pkg, require, character.only = TRUE)
}
installLoadPackages(packages)

```

## Data structures

### Check out the structure of an `sf` object. 
```{r view_structure}
library(sf)
nc <- st_read(system.file("shape/nc.shp", package="sf"), quiet = T)

head(nc)

# Note that nc is a collection of simple features, each of which is described by a row

```

### Now see what it looks like
```{r plot_nc}
plot(nc)
```

### Create the simplest simple feature geometry: a `POINT`
```{r make_points}
point_in_space <- c(1,2) #in XY space

point_geometry <- st_point(point_in_space)


point_geometry
plot(point_geometry)
```

### Combine multiple points into a `MULTIPOINT` geometry
```{r make_multipoints}
points_in_space <- rbind(c(3.2,4), c(3,4.6))

multipoint_geometry <- st_multipoint(points_in_space)


multipoint_geometry
plot(multipoint_geometry)
```

### Create a `LINESTRING` using the same points
```{r make_linestring}
linestring_geometry <- st_linestring(points_in_space)

linestring_geometry
plot(linestring_geometry)
```

## Working with `sf`

### Reading spatial data

```{r epu_shapes}

#Set relative path to data directory
epu.dir <- here::here("data","EPU_shapefile")

#Read in shapefile using sf
sf_shape <- 
  st_read(file.path(epu.dir,"EPU_extended.shp"),quiet = T)

#Read in shapefile using rgdal
rgdal_shape <-
  readOGR(file.path(epu.dir,"EPU_extended.shp"),verbose = F)

epu <- sf_shape %>% dplyr::select(EPU)
plot(epu)
  
```

### Converting between `sf` and `sp` classes

* Check out the class of the shapefile loaded with `rgdal`
```{r sp_to_sf}
#Read in shapefile using rgdal
class(rgdal_shape)
```

* Convert to `sf` using `methods::as()`
```{r sp_to_sf2}

sf_shape <- as(rgdal_shape, "sf")

# Or the same thing in tidy style

sf_shape <- rgdal_shape %>% 
  as("sf")

class(sf_shape)
```


### Identify existing Coordinate Reference System
```{r st-crs, echo = TRUE}
st_crs(epu)
```


### Change the Coordinate Reference System
```{r st-transform}

#Pass a proj4string
p4s <- "+proj=longlat +datum=NAD27 +no_defs"
st_transform(epu, p4s)

#Pass an EPSG code
epsg <- 4627
st_transform(epu, epsg)
```


## Simple Features (sf)

https://r-spatial.github.io/sf/articles/sf1.html

* What are `simple features`?

  * A formally recognized standard for encoding spatial information 
  * Implemented widely in spatial databases and commercial GIS outside of R (e.g. PostGIS, ArcGIS)
  * A data structure with both spatial and non-spatial attributes
  
* Why `sf`?
  * Methods for interfacing with spatial data have existed for a long time in R, but using them is a pain.
  * `sf` is built to be the successor to these sometimes painful libraries, such as `sp`
  
* What is a feature?
  * A feature is a real-world object (forests are features, but so are trees in the forests.)

* What's in a feature?
  * Geometry - A descriptor of location.
  * Attributes - Descriptors of feature properties (e.g. temperature)
  * Show diagram
  
* Interacting with simple features in R
  * All functions and methods in `sf` begin with `st_`
  * Attributes and geometries are stored as `data.frame` columns
  
* What's the difference between a GEOMETRY and GEOMETRYCOLLECTION?
  * If a single sf contains more than one *type* of GEOMETRY, it is a GEOMETRYCOLLECTION
  * For example, a single simple feature with both points and lines would be of type GEOMETRYCOLLECTION

* What's the difference between a POLYGON and a MULTIPOLYGON geometry type?
  * POLYGONs are allowed to have an exterior ring and zero or more interior rings
  * MULTIPOLYGONS are composed of multiple POLYGONS
  * This means that MULTIPOLYGONs are lists of lists of matrices
  
* How are data represented in different geometries?
  * All geometries are represented as lists of matrices (code example)
  
* What is a `proj4string` and how is it used?
  * All geometries in an `sf` object must have the same coordinate reference system (CRS)
  * A generic, string-based description of a coordinate reference system. 
  * The `proj4string` conveys information about a given coordinate transformation, that is, how geospatial information should be represented on a piece of paper. Included within the `proj4string` is a projection argument. This describes a mathematical transformation of a section of a spheroid onto a 2D surface. 
    * A datum. The datum defines the size, orientation, and position of an ellipsoid that approximates the shape of the earth. It forms a reference point for coordinate pairs.
  * `epsg`: An integer code for a specific coordinate reference system that can be resolved into a `proj4string`

* Transforming CRSs:
  * CRS transformations are performed using `st_transform()` in `sf`.
  * This method allows for use to convert between datum types. For example, between lat/lon in NAD27 datum to web mercator (used by web maps like Google Maps). Web mercator 
https://gis.stackexchange.com/questions/664/difference-between-projection-and-datum


```{r}
library(sf)

nc <- st_read(system.file("shape/nc.shp", package="sf"))

```

